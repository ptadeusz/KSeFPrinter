<?xml version="1.0" encoding="UTF-8"?>
<Wix xmlns="http://wixtoolset.org/schemas/v4/wxs"
     xmlns:ui="http://wixtoolset.org/schemas/v4/wxs/ui">

  <Package Name="KSeF Printer"
           Manufacturer="KSeF Team"
           Version="1.0.0.0"
           UpgradeCode="B8A2F9C3-7E4D-4F6A-9B2C-8D5E7F4A3B1C"
           Compressed="yes"
           InstallerVersion="500"
           Scope="perMachine"
           Codepage="1250">

    <SummaryInformation Description="Generator wydruków PDF dla faktur elektronicznych w formacie KSeF FA(3)" />

    <!-- Pozwól na upgrade przy reinstalacji -->
    <MajorUpgrade DowngradeErrorMessage="Nowsza wersja KSeF Printer jest już zainstalowana."
                  AllowSameVersionUpgrades="yes" />

    <!-- Dodaj standardowy UI WiX -->
    <ui:WixUI Id="WixUI_FeatureTree" />
    <WixVariable Id="WixUILicenseRtf" Value="License.rtf" />

    <!-- Ikona w Add/Remove Programs (opcjonalne - odkomentuj jeśli masz icon.ico) -->
    <!-- <Icon Id="ProductIcon" SourceFile="icon.ico" /> -->
    <!-- <Property Id="ARPPRODUCTICON" Value="ProductIcon" /> -->

    <!-- Właściwości instalacji -->
    <Property Id="WIXUI_INSTALLDIR" Value="INSTALLFOLDER" />

    <!-- Struktura katalogów -->
    <StandardDirectory Id="ProgramFiles64Folder">
      <Directory Id="INSTALLFOLDER" Name="KSeF Printer">
        <!-- Aplikacja CLI -->
        <Directory Id="CLIINSTALLFOLDER" Name="CLI" />

        <!-- Aplikacja API -->
        <Directory Id="APIINSTALLFOLDER" Name="API" />

        <!-- Przykłady -->
        <Directory Id="EXAMPLESINSTALLFOLDER" Name="Examples">
          <Directory Id="EXAMPLESXMLINSTALLFOLDER" Name="xml" />
          <Directory Id="EXAMPLESOUTPUTINSTALLFOLDER" Name="output" />
        </Directory>

        <!-- Dokumentacja -->
        <Directory Id="DOCUMENTATIONINSTALLFOLDER" Name="Documentation" />
      </Directory>
    </StandardDirectory>

    <!-- Start Menu -->
    <StandardDirectory Id="ProgramMenuFolder">
      <Directory Id="ApplicationProgramsFolder" Name="KSeF Printer" />
    </StandardDirectory>

    <!-- Feature 1: Aplikacja CLI (ksef-pdf.exe) -->
    <Feature Id="CLIFeature"
             Title="KSeF Printer CLI"
             Description="Aplikacja konsolowa do generowania PDF z faktur XML (ksef-pdf.exe)"
             Level="1"
             ConfigurableDirectory="CLIINSTALLFOLDER"
             Display="expand"
             AllowAbsent="no">

      <ComponentGroupRef Id="CLIComponents" />

      <!-- Skrót w Start Menu dla CLI -->
      <Component Id="CLIShortcut" Directory="ApplicationProgramsFolder" Guid="A1B2C3D4-E5F6-4A5B-8C7D-9E0F1A2B3C4D">
        <Shortcut Id="CLIShortcut"
                  Name="KSeF Printer CLI"
                  Description="Uruchom wiersz polecenia w folderze KSeF Printer CLI"
                  Target="[System64Folder]cmd.exe"
                  Arguments='/k cd /d "[CLIINSTALLFOLDER]" &amp; echo Folder: [CLIINSTALLFOLDER] &amp; echo Użycie: ksef-pdf.exe [plik.xml] [wyjscie.pdf]'
                  WorkingDirectory="CLIINSTALLFOLDER" />

        <RemoveFolder Id="RemoveCLIShortcut" Directory="ApplicationProgramsFolder" On="uninstall" />
        <RegistryValue Root="HKCU" Key="Software\KSeF\KSeFPrinter" Name="CLIInstalled" Type="integer" Value="1" KeyPath="yes" />
      </Component>

      <!-- Dodaj CLI do PATH (opcjonalne) -->
      <Component Id="CLIPathEnvironment" Directory="CLIINSTALLFOLDER" Guid="B2C3D4E5-F6A7-4B5C-8D7E-9F0A1B2C3D4E">
        <Environment Id="PATH_CLI"
                     Name="PATH"
                     Value="[CLIINSTALLFOLDER]"
                     Permanent="no"
                     Part="last"
                     Action="set"
                     System="yes" />
        <RegistryValue Root="HKCU" Key="Software\KSeF\KSeFPrinter" Name="CLIPath" Type="integer" Value="1" KeyPath="yes" />
      </Component>
    </Feature>

    <!-- Feature 2: Aplikacja API (opcjonalna) -->
    <Feature Id="APIFeature"
             Title="KSeF Printer API"
             Description="ASP.NET Core Web API z interfejsem Swagger"
             Level="1000"
             ConfigurableDirectory="APIINSTALLFOLDER"
             Display="expand"
             AllowAbsent="yes">

      <ComponentGroupRef Id="APIComponents" />

      <!-- Skrót w Start Menu dla API -->
      <Component Id="APIShortcut" Directory="ApplicationProgramsFolder" Guid="C3D4E5F6-A7B8-4C5D-8E7F-9A0B1C2D3E4F">
        <Shortcut Id="APIShortcut"
                  Name="Otwórz API w przeglądarce"
                  Description="Otwórz Swagger UI w przeglądarce (http://localhost:5000)"
                  Target="[System64Folder]cmd.exe"
                  Arguments='/c start http://localhost:5000'
                  WorkingDirectory="APIINSTALLFOLDER" />

        <RemoveFolder Id="RemoveAPIShortcut" Directory="ApplicationProgramsFolder" On="uninstall" />
        <RegistryValue Root="HKCU" Key="Software\KSeF\KSeFPrinter" Name="APIInstalled" Type="integer" Value="1" KeyPath="yes" />
      </Component>

      <!-- Skrót: Start Service -->
      <Component Id="APIServiceStartShortcut" Directory="ApplicationProgramsFolder" Guid="D4E5F6A7-B8C9-4D5E-8F7A-9B0C1D2E3F4B">
        <Shortcut Id="StartServiceShortcut"
                  Name="Uruchom KSeF Printer API (Serwis)"
                  Description="Uruchom serwis Windows API"
                  Target="[System64Folder]cmd.exe"
                  Arguments='/c net start KSeFPrinterAPI &amp;&amp; echo Serwis uruchomiony &amp;&amp; pause'
                  WorkingDirectory="APIINSTALLFOLDER" />

        <RegistryValue Root="HKCU" Key="Software\KSeF\KSeFPrinter" Name="StartServiceShortcut" Type="integer" Value="1" KeyPath="yes" />
      </Component>

      <!-- Skrót: Stop Service -->
      <Component Id="APIServiceStopShortcut" Directory="ApplicationProgramsFolder" Guid="E5F6A7B8-C9D0-4E5F-8A7B-9C0D1E2F3A4C">
        <Shortcut Id="StopServiceShortcut"
                  Name="Zatrzymaj KSeF Printer API (Serwis)"
                  Description="Zatrzymaj serwis Windows API"
                  Target="[System64Folder]cmd.exe"
                  Arguments='/c net stop KSeFPrinterAPI &amp;&amp; echo Serwis zatrzymany &amp;&amp; pause'
                  WorkingDirectory="APIINSTALLFOLDER" />

        <RegistryValue Root="HKCU" Key="Software\KSeF\KSeFPrinter" Name="StopServiceShortcut" Type="integer" Value="1" KeyPath="yes" />
      </Component>

      <!-- Skrót: Restart Service -->
      <Component Id="APIServiceRestartShortcut" Directory="ApplicationProgramsFolder" Guid="F6A7B8C9-D0E1-4F5A-8B7C-9D0E1F2A3B4D">
        <Shortcut Id="RestartServiceShortcut"
                  Name="Restart KSeF Printer API (Serwis)"
                  Description="Restartuj serwis Windows API"
                  Target="[System64Folder]cmd.exe"
                  Arguments='/c net stop KSeFPrinterAPI &amp; net start KSeFPrinterAPI &amp;&amp; echo Serwis zrestartowany &amp;&amp; pause'
                  WorkingDirectory="APIINSTALLFOLDER" />

        <RegistryValue Root="HKCU" Key="Software\KSeF\KSeFPrinter" Name="RestartServiceShortcut" Type="integer" Value="1" KeyPath="yes" />
      </Component>

      <!-- Skrót: Service Status -->
      <Component Id="APIServiceStatusShortcut" Directory="ApplicationProgramsFolder" Guid="A1B2C3D4-E5F6-7A8B-9C0D-1E2F3A4B5C6D">
        <Shortcut Id="ServiceStatusShortcut"
                  Name="Status serwisu API"
                  Description="Sprawdź status serwisu Windows API"
                  Target="[System64Folder]WindowsPowerShell\v1.0\powershell.exe"
                  Arguments='-NoExit -Command "Get-Service KSeFPrinterAPI | Format-List Name, Status, StartType, DisplayName"'
                  WorkingDirectory="APIINSTALLFOLDER" />

        <RegistryValue Root="HKCU" Key="Software\KSeF\KSeFPrinter" Name="StatusServiceShortcut" Type="integer" Value="1" KeyPath="yes" />
      </Component>
    </Feature>

    <!-- Feature 3: Pliki przykładowe (opcjonalne) -->
    <Feature Id="ExamplesFeature"
             Title="Przykłady"
             Description="Przykładowe faktury XML i wygenerowane PDF-y"
             Level="1000"
             AllowAbsent="yes">

      <ComponentGroupRef Id="ExamplesComponents" />
    </Feature>

    <!-- Feature 4: Dokumentacja (zalecane) -->
    <Feature Id="DocumentationFeature"
             Title="Dokumentacja"
             Description="Przewodniki instalacji, licencjonowania i konfiguracji certyfikatów"
             Level="1"
             AllowAbsent="yes">

      <ComponentGroupRef Id="DocumentationComponents" />

      <!-- README w głównym folderze -->
      <Component Id="ReadmeComponent" Directory="INSTALLFOLDER" Guid="D4E5F6A7-B8C9-4D5E-8F7A-9B0C1D2E3F4A">
        <File Id="ReadmeFile" Source="..\README.md" KeyPath="yes" />
      </Component>
    </Feature>

  </Package>
</Wix>
